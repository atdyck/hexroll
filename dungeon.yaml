Globals:
  Counter:
    - 0


Dungeon:
  $collection: dungeons
  $subclass: !parameter dungeon_classes

  $collections:
    dungeon_locks:
      $collect: DungeonDoorLock

    dungeon_keys:
      $collect: DungeonDoorKey

    dungeon_levers:
      $collect: DungeonDoorLever

    dungeon_portal_destinations:
      $collect: DungeonPortalDestination

    dungeon_monsters:
      $collect: Monster

  Details: !jinja >

    %%end_div

    <div class='pagebreak'> </div>

    ### <a name='{{uuid}}'></a>{{Name.Title}}


    <a href='{{uuid}}.webp'><img src='{{uuid}}.webp'/></a>


    %%begin_div

    #### Wandering Monsters

    There is a __1 in 6 chance__ of encountering one of the
    following wandering monsters, after __every 2 turns__.


    {{WanderingMonsters.Table}}

    {{Map.Details}}

  Title: !jinja "{{Name.Title}}"


DungeonWanderingMonsters:
  Encounters:
    $popsome:
      $collection: dungeon_monsters
      $min: 6
      $max: 6
  Table: !jinja > 
    {%set counter = namespace(value=1)%}
    <table class='randenc'>
    <thead>
    <tr><th>1d{{Encounters|length}}</th><th>Encounter</th><th>stats</th></tr>
    </thead>
    <tbody>
    {%for e in Encounters%}
    {%if e.NumberAppearingRoaming > 1%}
    {%set number = namespace(value=(range(1, e.NumberAppearingRoaming) | random))%}
    {%else%}
    {%set number = namespace(value=1)%}
    {%endif%}
    <tr><td>{{counter.value}}</td><td><strong>{{e.Title}}{% if number.value>1%}s</strong> ({{number.value}}){%endif%}</strong></td><td> {{e.Stats}}</td></tr>
    {%-set counter.value = counter.value+1-%}{%-endfor%}
    </tbody>
    </table>


AreaDescription:
  Title: !jinja "{{RoomType.Title}}"

  Description: !jinja >
    ##### Description

    > {{RoomType.Preface}} and {{Decor.Description}}.
    {{Feature.Hint}}{%if Cell.Active%} and {{Cell.Hint}}{%endif%}.


    {%if AreaTrap.Description and Feature.subclass_=='DungeonRemains' -%}
    * {{AreaTrap.Description}} 
    {%-endif%}


    * {{Feature.Description}}


    * {{Debris.Description}}


    {%if Key.Active%}
    * Searching will uncover {{KeyHide}} holding the {{Key.Active}}
    {%endif%}

    {%if Lever.Active%}
    * There’s {{Lever.Active | articlize}}
    {%endif%}

    {%if TreasureHiding.Active%}
    * {{TreasureHiding.Active}}
    {%endif%}

    {%if Cell.Active%}
    * {{Cell.Active}}.
      {%if AreaTrap.Description 
           and Feature.subclass_=='DungeonRemains'
           and (range(1,3+1) | random)==3-%}
      Though {{Cell.Pronoun2}} mouth is gagged, {{Cell.Pronoun}} will
      try to warn about the trap.{%-endif%}
    {%endif%}

    {%if PortalDestination.Active%}
    * {{PortalDestination.Active}}.
    {%endif%}

  Debris:
    $roll: DungeonDebris

  $context:
    $attr: RoomContext
    $values:
      - Ref
      - CounterSnapshot

  Feature:
    $roll:
      $class: !indirect FeatureLevelClass


  AreaTrap:
    $roll: AreaTrap

  Key:
    $roll: DungeonDoorKey

  KeyHide:
    - a small wooden box
    - a nook in the wall
    - a cloth wrap under a stone
    - a goat’s skull
    - an old leather pouch
    - a crack in the floor
    - an old hollow torch

  Lever:
    $roll: DungeonDoorLever

  Cell:
    $roll: MissingPersonQuestCell

  TreasureHiding:
    $roll: QuestTreasureHiding

  PortalDestination:
    $roll: DungeonPortalDestination

  Foreshadow: !jinja >
    {% if Feature.Foreshadow or Cell.Active%}
    
    ##### Foreshadowing

    {% if Feature.Foreshadow%}
    * {{Feature.Foreshadow}}.
    {%endif%}

    {% if Cell.Active %}
    {% if Feature.Monster %}
    * A successful listening roll will {{'also' if Feature.Foreshadow else
      ''}} reveal __screams of fear__ coming from inside this area.

    {%else%}

    * A successful listening roll will {{'also' if Feature.Foreshadow else
      ''}} reveal a faint __sound of crying__ coming from inside this area.

    {%endif%}
    {%endif%}

    {%endif%}


RoomDescription:
  $extends: AreaDescription
  Decor:
    $roll: DungeonDecor

  RoomType:
    $roll: RoomType


CaveDescription:
  $extends: AreaDescription
  Decor:
    $roll: CaveDecor

  RoomType:
    $roll: CaveType


DungeonDebris:
  Description: !jinja >
    There’s also {{Debris1}} {{Debris1Location}} and some {{Debris2}}
    {{Debris2Location}}

  Debris1Location:
    - in the far corner
    - in the near corner
    - near the wall on the left
    - near the wall on the right
    - near the wall on the far end

  Debris2Location:
    - next to it
    - spread all over the place

  Debris1:
    - an old, ripped backpack
    - a used flask of oil
    - a torn quiver
    - a rusty short sword
    - a burnt torch
    - an old broken mirror

  Debris2:
    - broken pieces of wood
    - torn pieces of clothing
    - rotting remains of food
    - dry remains of food
    - ripped pieces of old rope
    - traces of fur
    - garlic leftovers


DungeonDecor:
  Description:
    - !jinja >
      there are {{Quantity}} {{Cover}} on the {{Part}}
    - !jinja >
      the {{Part}} {{'have' if Part|last=='s' else 'has'}} {{Quantity}} {{Cover}} on
    - !jinja >
      the {{Part}} {{'are' if Part|last=='s' else 'is'}} covered with {{Cover}}
    - !jinja >
      the {{Part}} {{'are' if Part|last=='s' else 'is'}} {{State}}

  Part: !avoid_repeating
    - walls
    - ground
    - ceiling

  Cover:
    - splatters of dark matter
    - claw marks
    - burn marks
    - scorch marks
    - cracks
    - fractures
    - spots of green rot
    - spots of yellow ooze

  State:
    - deeply fractured
    - scorched with burn marks
    - carved with claw marks

  Recency:
    - old
    - fresh

  Quantity:
    - a few
    - some
    - several


CaveDecor:
  $extends: DungeonDecor
  Part: !avoid_repeating
    - stalagmites
    - stalactites
    - ground
    - canopy


DungeonFeature:
  $subclass:
    - DungeonEncounter
    - DungeonContainers
    - DungeonRemains
    - DungeonFungi


DungeonFeatureExtreme:
  $subclass:
    - DungeonEncounterExtreme


DungeonEncounter:
  Description: !jinja |
    {%if Monster.NumberAppearingRoaming==1%}There’s {{Monster.Title | articlize}}{%else%} There are {{Monster.NumberAppearingRoaming}} {{Monster.Title}}s {%endif%} inside.
    {%if Monster.Intelligent %}Roll or decide for reaction.
    {%else%}{%if Monster.NumberAppearingRoaming==1%}It {%else%} They {%endif%} will attack anyone stepping in. {%endif%}

    __{{Monster.Title}}__

    ---

    {{Monster.Stats}}
    {%if Monster.NumberAppearingRoaming<10%}{%for m in range(Monster.NumberAppearingRoaming)%}
    <sub>{% for hp in range(Monster.HitDiceRoll | diceroll) %}❏{%endfor%}</sub><br/> {%endfor%}{%endif%}

    ---

    {%if not Monster.TreasureType.Empty and (Monster.TreasureType.Details|trim)!=''%}
    * Monster Hoard:
    {{Monster.TreasureType.Details}}
    {%else%}
    * There is no hoard.
    {%endif%}


Stats:
  Text: !jinja |
    __Armour Class:__ {{Monster.ArmourClass}} __Hit Dice:__ {{Monster.HitDice}} __Attacks:__ {{Monster.Attacks}}
    __THAC0:__ {{Monster.THAC0}} __Movement:__ {{Monster.Movement}} __Saving Throws:__ {{Monster.SavingThrows}}


DungeonContainers:
  Hint: !jinja >
    There {{'is a' if Quantity=='single' else 'are some'}} {{Size}}
    {{Type}}{{'' if Quantity=='single' else 's'}} near the far wall

  Description: !jinja >
    {%if Trap.Description%}The {{Type}}{{' is' if Quantity=='single' else 's are'}} trapped. {{Trap.Description}}


    * {%-endif%} {%if (Treasure.Details | trim)==''%} The treasure here, if any, was __already looted__.{%else%}There’s a 2-in-6 chance the {{Type}}{{'' if Quantity=='single' else 's'}}
      contain{{'s' if Quantity=='single' else ''}}:  {{Treasure.Details}}
        Otherwise, this place was already looted earlier.{%endif%}

  Foreshadow: 
    - !jinja >
      A few single {{['silver', 'copper'] | random}} pieces could be found if examining the ground near
      the entrances to this area
    
    - Traces of something heavy dragged on the ground could be found if examining
      around the entrances to this area

    - A torn canvas bag was left on the ground near an entrance to this area


  Type:
    - jar
    - chest
    - crate
    - barrel
    - bag

  Quantity:
    - single
    - multiple

  Size:
    - large
    - small
    - very big
    - big

  Trap:
    $roll:
      $class: ContainerTrap
      $inject:
        $namespace: container
        $values:
          Type: !jinja "{{container.Type}}{{'' if container.Quantity=='single' else 's'}}"
          AgentLocation: !jinja >
            {{ {'jar'   : 'embedded in a handle',
                'chest' : 'hidden under a pulling ring',
                'crate' : 'embedded in one of the wooden planks',
                'barrel': 'hidden in a rim',
                'bag'   : 'thrown casually inside'}[container.Type] }} 





DungeonTreasureTier1:
  $extends: DungeonContainers
  Treasure:
    $roll: TreasureTypeTier1


DungeonTreasureTier2:
  $extends: DungeonContainers
  Treasure:
    $roll: TreasureTypeTier2


DungeonTreasureTier3:
  $extends: DungeonContainers
  Treasure:
    $roll: TreasureTypeTier3


DungeonTreasureTier4:
  $extends: DungeonContainers
  Treasure:
    $roll: TreasureTypeTier3


DungeonFungi:
  Hint:
    - Faint colorful light is emitting from everywhere
    - There’s also a colorful glow emitted from the ground

  Description: 
    - !jinja > 
      {{Quantity | capitalize}} green and purple bioluminescent mushrooms are
      growing from cracks in the ground. Anyone consuming them {{Effect}}

    - !jinja > 
      There are {{Quantity}} colorful bioluminescent mushrooms growing from
      cracks in the ground. Anyone consuming these {{Effect}}

    - !jinja > 
      {{Quantity | capitalize}} blue, red and yellow bioluminescent mushrooms
      are growing from cracks in the ground. Anyone consuming them {{Effect}}

    - !jinja > 
      There are {{Quantity}} colorful bioluminescent mushrooms growing from
      cracks in the ground. Anyone consuming these will gain the same
      effect as if they consumed {{PotionEffect.Item | articlize}}

  Quantity:
    - a few
    - a few dozen of
    - countless

  Effect: !weighted
    - might be severely __poisoned__ (__1d4 of damage__ until a successful saving throw per turn)
    - will be __paralized__ with mind twisting hallucinations for __1d6 turns__^3
    - will suffer a severe stomach ache and a __-2 penalty__ to attack rolls for __1d6 turns__^4

  PotionEffect:
    $roll: RandomPotion


RandomEquipmentOnBody:
  $subclass: !avoid_repeating
    - Club
    - Dagger
    - Mace
    - ShortBow
    - SilverDagger
    - Sling
    - Sword
    - IronRations
    - Mirror
    - IronSpikes
    - HolySymbol
    - Garlic
    - SmallSack
    - Rope
    - Pole
    - Oil
    - SmallHammer
    - ThieveTools
    - ClothingAdventurerBoots
    - ClothingHighBoots
    - ClothingWarmCloak
    - ClothingLeatherHat

RandomEquipmentOnBodyState:
  - Usable
  - Unusable

DungeonRemains:
  Hint: !weighted
    - There’s something lying on the floor^2
    - You spot something quite big lying on the floor^2
    - There’s a dead body here

  Description: !jinja >
    Lying on the floor is a __{{Remains}}__.
    {%if (Treasure.Details | trim)=='' and EquipmentItems < 1 and not Key.Active%}
    Searching it will uncover __nothing__.
    {%else%}
    Searching it will uncover: {{Treasure.Details}}

    {%if EquipmentItems > 0%}    * __{{EquipmentItem1.Title | nobrackets}}__ ({{EquipmentItem1State}}){%endif%}  


    {%if EquipmentItems > 1%}    * __{{EquipmentItem2.Title | nobrackets}}__ ({{EquipmentItem2State}}){%endif%}  


    {%if EquipmentItems > 2%}    * __{{EquipmentItem3.Title | nobrackets}}__ ({{EquipmentItem3State}}){%endif%}  

    {%if Key.Active%}    *  The {{Key.Active}} {%endif%}

    {%endif%}

  Treasure:
    $roll: TreasureTypeBody

  EquipmentItems:
    $diceroll: 1d4-1
  EquipmentItem1:
    $roll: RandomEquipmentOnBody
  EquipmentItem1State:
    $roll: RandomEquipmentOnBodyState
  EquipmentItem2:
    $roll: RandomEquipmentOnBody
  EquipmentItem2State:
    $roll: RandomEquipmentOnBodyState
  EquipmentItem3:
    $roll: RandomEquipmentOnBody
  EquipmentItem3State:
    $roll: RandomEquipmentOnBodyState
  Key:
    $roll: DungeonDoorKey

  Remains: !weighted 
    - dust covered human skeleton^2
    - dust covered skeleton of an orc
    - dust covered skeleton of a goblin
    - rotting human corpse^2
    - rotting orc corpse
    - rotting goblin corpse


DungeonPortalDestination:
  Location: !jinja "{{RoomContext.Ref}}"


DungeonPortal:
  Title: magical portal
  Description: !jinja >
    {{Portal | articlize | capitalize}} is a magical portal.
    Anyone stepping into the portal will be magically teleported
    into __area {{Destination.Location}}__
  Destination: 
    $pop:
      $collection: dungeon_portal_destinations
      $inject:
        $namespace: portal
        $values:
          Active: !jinja >
            {{portal.Portal | articlize | capitalize}} is a magical portal.
            Anyone steppping into the portal will be magically teleported into
            __area {{portal.Origin}}__

  Portal:
    - __painting of a door__ on the wall
    - stained old __full-size mirror__ on the wall
    - stone-carved __demon face__ on the wall with a large gaping mouth


DungeonFountain:
  Title: fountain
  Description: !jinja >
    {{Liquid | capitalize}} coming out of {{Outlet}} here
  Liquid:
    - clear water are
    - dark liquid is
  Outlet:
    - a hole in the wall
    - a stone statue of a fish


DungeonDeadEndFeature:
  Title: !jinja >
    {% if Feature.class_=='DungeonPortal' %}
    Dead End (Magical Portal)
    {% elif Feature.class_=='AreaTrap' and Feature.Description %}
    Dead End (Trap!)
    {% elif Feature.class_=='DungeonFountain' %}
    Dead End (Fountain)
    {% elif Feature.class_=='DungeonRemains' %}
    Dead End (Body)
    {% else %}
    Dead End
    {% endif %}
  Description: !jinja >
    {% if Feature.Description %}
    * {{Feature.Description}}
    {% else %}
    * There is nothing here.
    {% endif %}
  $context:
    $attr: RoomContext
    $values:
      - Ref
      - CounterSnapshot
  Feature:
    $roll:
      $class:
        - DungeonPortal
        - AreaTrap
        - DungeonFountain
        - DungeonRemains
      $bootstrap:
        Origin: !ref Origin


DungeonAlcoveFeature:
  - There are oversized torches in the alcoves here.
  - There are human-like statues in the alcoves here.
  - There are hanging cages in the alcoves here. There are bare skeletons inside.
